{% extends "base.html" %}
{% block heading %}
<div class="panel panel-default">
  <div class="panel-body">
    <div class="container">
      <ol class="breadcrumb">
        <li><a href="/"><i class="fa fa-home fa-fw"></i></a></li>
        <li><a href="/petitions">Petitions</a></li>
        <li class="active">{{ data['data']['id'] }}</li>
      </ol>
      <h3><b>Petition:</b> {{ data['data']['attributes']['action'] }}</h3>
      <p class="lead">{{ data['data']['attributes']['signature_count'] }} signatures as of {{ data['data']['attributes']['updated_at'] }}</p>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-6">
    <div class="row">
      <!-- Background Panel -->
      <div class="col-md-12">
        <div class="panel panel-default">
          <div class="list-group">
            <div class="list-group-item">
              <h5 class="list-group-item-heading"><i class="fa fa-quote-left fa-fw"></i> Background</h5>
            </div>
            <div class="list-group-item">
              <p>{{ data['data']['attributes']['background']|urlize(40) }}</p>
              {% if data['data']['attributes']['additional_details'] %}
              <a role="button" data-toggle="collapse" href="#additional_details" aria-expanded="false" aria-controls="additional_details"><i class="fa fa-caret-right fa-fw"></i>More details</a>
              <div class="collapse" id="additional_details">
                <p>{{ data['data']['attributes']['additional_details']|urlize(40) }}</p>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- History Panel -->
      <div class="col-md-12">
        <div class="panel panel-default">
          <div class="list-group">
            <div class="list-group-item">
              <h5 class="list-group-item-heading"><i class="fa fa-history fa-fw"></i> History</h5>
            </div>
            <div class="list-group-item">
              {% if data['data']['attributes']['created_at'] %}<p><b>{{ data['data']['attributes']['created_at'] }}:</b> Created by {{ data['data']['attributes']['creator_name'] }}.</p>{% endif %}
              {% if data['data']['attributes']['moderation_threshold_reached_at'] %}<p><b>{{ data['data']['attributes']['moderation_threshold_reached_at'] }}:</b> Moderation threshold reached.</p>{% endif %}
              {% if data['data']['attributes']['open_at'] %}<p><b>{{ data['data']['attributes']['open_at'] }}:</b> Opened.</p> {% endif %}
              {% if data['data']['attributes']['response_threshold_reached_at'] %}<p><b>{{ data['data']['attributes']['response_threshold_reached_at'] }}:</b> 10,000 signature response target met.</p>{% endif %}
              {% if data['data']['attributes']['government_response_at'] %}<p><b>{{ data['data']['attributes']['government_response_at'] }}:</b> Government responded.</p>{% endif %}
              {% if data['data']['attributes']['debate_threshold_reached_at'] %}<p><b>{{ data['data']['attributes']['debate_threshold_reached_at'] }}:</b> 100,000 signature debate target met.</p>{% endif %}
              {% if data['data']['attributes']['debate_outcome_at'] %}<p><b>{{ data['data']['attributes']['debate_outcome_at'] }}:</b> Debate outcome.</p>{% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Map Panel -->
  <div class="col-md-6">
    <div class="panel panel-default">
      <div class="list-group">
        <div class="list-group-item">
          <h5 class="list-group-item-heading"><i class="fa fa-map-o fa-fw"></i> Map</h5>
        </div>
        <div class="list-group-item" id="map" style="width: 100%; height: 350px">
          <script type="text/javascript">
          var map = L.map('map').setView([54.525564, -3.921976], 5);

          L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(map);

          var myStyle = {
              color: "#2196f3",
              opacity: 1
          };

          function onEachFeature(feature, layer) {
            layer.bindPopup("<b>" + feature.properties.name + "</b><p><i class=\"fa fa-user fa-fw\"></i> " + feature.properties.mp + "</p><p><i class=\"fa fa-pencil fa-fw\"></i> " + feature.properties.signature_count + " signatures</p>");
          }

          var geojson = L.geoJson({{extents|safe}}, {style: myStyle, onEachFeature: onEachFeature}).addTo(map);

          //Center map view on geojson
          map.fitBounds(geojson.getBounds());
          </script>
        </div>
      </div>
      <div class="panel-footer">
        <a class="btn btn-default" href="{{ data['data']['id'] }}/map" role="button"><i class="fa fa-expand fa-fw"></i> Fullscreen</a>
      </div>
    </div>
  </div>
</div>

<!-- Response Panel -->
<div class="row">
  <div class="col-md-12">
    <div class="panel panel-default">
      <div class="list-group">
        <div class="list-group-item">
          <h5 class="list-group-item-heading"><i class="fa fa-comments-o fa-fw"></i> Response <small class="pull-right">{{ data['data']['attributes']['government_response']['updated_at'] }}</small></h5>
        </div>
        <div class="list-group-item">
          {% if data['data']['attributes']['response_threshold_reached_at'] %}
            {% if data['data']['attributes']['government_response'] %}
            <p>{{ data['data']['attributes']['government_response']['summary']|urlize(40) }}</p>
            <a role="button" data-toggle="collapse" href="#details" aria-expanded="false" aria-controls="details"><i class="fa fa-caret-right fa-fw"></i>More details</a>
            <div class="collapse" id="details">
              <p>{{ data['data']['attributes']['government_response']['details']|urlize(40) }}</p>
            </div>
            {% else %}
            <p><b>Response target met:</b> Awaiting response</p>
            <p>{{ data['data']['attributes']['signature_count'] / 10000 * 100 }}% of 10,000 signatures.</p>
            <div class="progress">
              <div class="progress-bar" role="progressbar" aria-valuenow="{{ data['data']['attributes']['signature_count'] / 10000 * 100 }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ data['data']['attributes']['signature_count'] / 10000 * 100 }}%;">
                <span class="sr-only">{{ data['data']['attributes']['signature_count'] / 10000 * 100 }}% Complete</span>
              </div>
            </div>
            {% endif %}
          {% else %}
          <p>{{ data['data']['attributes']['signature_count'] / 10000 * 100 }}% of 10,000 signatures.</p>
          <div class="progress">
            <div class="progress-bar" role="progressbar" aria-valuenow="{{ data['data']['attributes']['signature_count'] / 10000 * 100 }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ data['data']['attributes']['signature_count'] / 10000 * 100 }}%;">
              <span class="sr-only">{{ data['data']['attributes']['signature_count'] / 10000 * 100 }}% Complete</span>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{% if data['data']['attributes']['rejection'] %}
<!-- Rejection Panel -->
<div class="row">
  <div class="col-md-12">
    <div class="panel panel-default">
      <div class="list-group">
        <div class="list-group-item">
          <h5 class="list-group-item-heading"><i class="fa fa-ban fa-fw"></i> Rejection: {{ data['data']['attributes']['rejection']['code']|capitalize }}<small class="pull-right">{{ data['data']['attributes']['rejected_at'] }}</small></h5>
        </div>
        <div class="list-group-item">
          <p>{{ data['data']['attributes']['rejection']['details']|urlize(40) }}</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}


<!-- Debate Panel -->
<div class="row">
  <div class="col-md-12">
    <div class="panel panel-default">
      <div class="list-group">
        <div class="list-group-item">
          <h5 class="list-group-item-heading"><i class="fa fa-comments-o fa-fw"></i> Debate <small class="pull-right">{{ data['data']['attributes']['debate']['debated_on'] }}</small></h5>
        </div>
        {% if data['data']['attributes']['debate_threshold_reached_at'] %}
          {% if data['data']['attributes']['debate'] %}
            {% if data['data']['attributes']['debate']['transcript_url'] %}
            <div class="list-group-item">
              <p><a href="{{data['data']['attributes']['debate']['transcript_url']}}"><i class="fa fa-file-text-o fa-fw"></i> Transcript</a></p>
            </div>
            {% endif %}
            {% if data['data']['attributes']['debate']['video_url'] %}
            <div class="list-group-item">
              <p><a href="{{data['data']['attributes']['debate']['video_url']}}"><i class="fa fa-video-camera fa-fw"></i> Video</a></p>
            </div>
            {% endif %}
            {% if data['data']['attributes']['debate']['overview'] %}
            <div class="list-group-item">
              <p>{{ data['data']['attributes']['debate']['overview']|urlize(40) }}</p>
            </div>
            {% endif %}
          {% else %}
            <div class="list-group-item">
              {% if data['data']['attributes']['scheduled_debate_date'] %}
              <p><b>Debate target met:</b> Scheduled for {{ data['data']['attributes']['scheduled_debate_date'] }}.</p>
              <p>{{ data['data']['attributes']['signature_count'] / 100000 * 100 }}% of 100,000 signatures.</p>
              <div class="progress">
                <div class="progress-bar" role="progressbar" aria-valuenow="{{ data['data']['attributes']['signature_count'] / 100000 * 100 }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ data['data']['attributes']['signature_count'] / 100000 * 100 }}%;">
                  <span class="sr-only">{{ data['data']['attributes']['signature_count'] / 100000 * 100 }}% Complete</span>
                </div>
              </div>
              {% else %}
              <p><b>Debate target met:</b> Awaiting debate date.</p>
              <p>{{ data['data']['attributes']['signature_count'] / 100000 * 100 }}% of 100,000 signatures.</p>
              <div class="progress">
                <div class="progress-bar" role="progressbar" aria-valuenow="{{ data['data']['attributes']['signature_count'] / 100000 * 100 }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ data['data']['attributes']['signature_count'] / 100000 * 100 }}%;">
                  <span class="sr-only">{{ data['data']['attributes']['signature_count'] / 100000 * 100 }}% Complete</span>
                </div>
              </div>
              {% endif %}
            </div>
          {% endif %}
        {% else %}
        <div class="list-group-item">
          <p>{{ data['data']['attributes']['signature_count'] / 100000 * 100 }}% of 100,000 signatures.</p>
          <div class="progress">
            <div class="progress-bar" role="progressbar" aria-valuenow="{{ data['data']['attributes']['signature_count'] / 100000 * 100 }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ data['data']['attributes']['signature_count'] / 100000 * 100 }}%;">
              <span class="sr-only">{{ data['data']['attributes']['signature_count'] / 100000 * 100 }}% Complete</span>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <div class="panel panel-default">
      <div class="list-group">
        <div class="list-group-item">
          <h5 class="list-group-item-heading"><i class="fa fa-map-signs fa-fw"></i> Signatures by constituency</h5>
        </div>
      </div>
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Constituency</th>
            <th>MP</th>
            <th>Signatories</th>
          </tr>
        </thead>
        <tbody>
          {% for constituency in constituencies %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ constituency.name }}</td>
            <td>{{ constituency.mp }}</td>
            <td>{{ constituency.signature_count }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="col-md-6">
    <div class="panel panel-default">
      <div class="list-group">
        <div class="list-group-item">
          <h5 class="list-group-item-heading"><i class="fa fa-globe fa-fw"></i> Signatures by country</h5>
        </div>
      </div>
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Country</th>
            <th>Signatories</th>
          </tr>
        </thead>
        <tbody>
          {% for country in countries %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ country.name }}</td>
            <td>{{ country.signature_count }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}
